(function(){"use strict";const p="https://cdn.jsdelivr.net/pyodide/v0.29.0/full/pyodide.mjs",e=self;e.workerState={pyodide:null,pyodide_url:p,packages:[],state:{msg:"loading",loaded:!1,progress:0},micropip:null,worker:{},pyodideReady:!1,pyodideReadyPromise:null,debug:!1,interruptBuffer:null,receivepy:(r,t)=>{},receivepy_bytes:(r,t)=>{},handel_register:{},post_pyodide_ready:void 0},e.reset=async()=>{for(const r in e.list_workers())try{const t=await e.get_worker(r);t.worker&&t.worker.stop(),t.reject_promise?.("Worker reset")}catch{}e.workerState.pyodide&&e.interrupt(),e.workerState.pyodide=null,e.workerState.micropip=null,e.workerState.worker={},e.workerState.pyodideReady=!1;try{e.workerState.interruptBuffer=new Uint8Array(new SharedArrayBuffer(1)),e.workerState.interruptBuffer[0]=0}catch{}},e.initializePyodide=async()=>{if(!e.workerState.pyodide){console.log("initializePyodide with: Debug:",e.workerState.debug,"Pyodide URL:",e.workerState.pyodide_url,"Packages:",e.workerState.packages),console.debug("Loading Pyodide..."),e.workerState.state.msg="Loading Pyodide...",e.workerState.state.progress=0,await e.reset(),console.debug("Loading Pyodide module..."),e.workerState.state.msg="Loading Pyodide module...",e.workerState.state.progress=.1;const r=await import(e.workerState.pyodide_url);console.debug("Loading Pyodide instance..."),e.workerState.state.msg="Loading Pyodide instance...",e.workerState.state.progress=.2;const t=r.loadPyodide,o=new URL(e.workerState.pyodide_url),n=new URL(".",o).toString();e.workerState.debug&&console.debug("Pyodide indexURL:",n),e.workerState.pyodide=await t({packages:["micropip"],indexURL:n}),e.workerState.interruptBuffer&&e.workerState.pyodide.setInterruptBuffer(e.workerState.interruptBuffer)}e.workerState.micropip||(console.debug("Importing micropip..."),e.workerState.state.msg="Importing micropip...",e.workerState.state.progress=.3,e.workerState.micropip=e.workerState.pyodide.pyimport("micropip")),console.debug("Pyodide ready. Installing funcnodes...");for(const r of e.workerState.packages)console.log("Installing package:",r),e.workerState.state.msg=`Installing package: ${r}`,await e.workerState.micropip.install(r);return e.workerState.state.msg="Installing funcnodes",e.workerState.state.progress=.8,await e.workerState.micropip.install("funcnodes"),e.workerState.state.msg="Installing funcnodes-worker",await e.workerState.micropip.install("funcnodes-worker"),e.workerState.packages.some(r=>r.toLowerCase().endsWith(".whl")&&r.includes("funcnodes_pyodide"))?e.workerState.debug&&console.debug("Skipping PyPI funcnodes-pyodide install (wheel provided in packages)"):(e.workerState.state.msg="Installing funcnodes-pyodide",await e.workerState.micropip.install("funcnodes-pyodide")),e.workerState.state.msg="Installing funcnodes-react-flow",await e.workerState.micropip.install("funcnodes-react-flow"),e.workerState.state.msg="Importing funcnodes",console.debug("Importing funcnodes..."),await e.workerState.pyodide.runPythonAsync("import funcnodes_pyodide"),console.debug("Running post_pyodide_ready..."),await e.workerState.post_pyodide_ready?.(e.workerState),console.debug("Pyodide ready"),e.workerState.state.msg="ready",e.workerState.state.progress=.1,e.workerState.pyodideReady=!0,{pyodide:e.workerState.pyodide,micropip:e.workerState.micropip}},e.interrupt=()=>{e.workerState.interruptBuffer&&(e.workerState.interruptBuffer[0]=1)},e.list_workers=()=>Object.keys(e.workerState.worker),e.get_worker=async r=>{if(!r)throw new Error("Worker id is required");if(!e.workerState.worker[r])throw new Error(`Worker with id ${r} not found`);return await e.workerState.worker[r].make_promise,e.workerState.worker[r]},e.has_worker=r=>{if(!r)throw new Error("Worker id is required");return!!e.workerState.worker[r]},e.get_or_create_worker=async r=>{if(!r)throw new Error("Worker id is required");return e.workerState.worker[r]||(console.log("Creating worker with id",r),await e.initializeFuncNodesWorker(r)),e.get_worker(r)},e.initializeFuncNodesWorker=async r=>{try{if(!e.workerState.pyodideReadyPromise)throw new Error("Pyodide newer initialized");const{pyodide:t}=await e.workerState.pyodideReadyPromise;if(!e.has_worker(r)){e.workerState.worker[r]={worker:null,make_promise:void 0};const o=new Promise(async(n,s)=>{e.workerState.worker[r].reject_promise=s,console.debug(`Creating worker (${r})...`);const i=await t.runPythonAsync(`funcnodes_pyodide.new_worker(debug=${e.workerState.debug?1:0}, uuid="${r}")`);if(console.debug("Worker created:",i),typeof i.set_receiver=="function")i.set_receiver(self);else throw new Error("Worker does not expose a 'set_receiver' method.");e.workerState.worker[r].worker=i,console.debug("Worker ready"),n(i)});e.workerState.worker[r].make_promise=o}return e.get_worker(r)}catch(t){throw console.error("Error during worker initialization:",t),t}},e.receivepy=(r,t)=>{try{let o={};if(typeof r=="string"?o.msg=r:o=r,o.msg===void 0)return;typeof o.msg!="string"&&(o.msg=JSON.stringify(o.msg)),t!==void 0&&(typeof t=="string"?o.worker_id||(o.worker_id=t):o={...t,...o});const n=o.worker_id;if(!n)throw new Error(`Worker id not provided in receivepy(${JSON.stringify(o)})`);if(!e.workerState.worker[n])throw new Error(`Worker with id ${n} not found in receivepy(${JSON.stringify(o)})`);e.workerState.receivepy(r,n)}catch(o){console.error("Error during receivepy:",o);return}},e.receivepy_bytes=(r,t)=>{let o=r;const n=r;if(n&&typeof n.toJs=="function")try{o=n.toJs({dict_converter:Object.fromEntries})}catch{o=n.toJs()}o instanceof Map&&(o=Object.fromEntries(o.entries()));try{let s={};if(o instanceof Uint8Array?s.msg=o:s=o,s.msg===void 0)return;let i=s.msg;const a=i;if(a&&typeof a.toJs=="function")try{i=a.toJs({dict_converter:Object.fromEntries})}catch{i=a.toJs()}if(i instanceof ArrayBuffer&&(i=new Uint8Array(i)),Array.isArray(i)&&(i=Uint8Array.from(i)),!(i instanceof Uint8Array))throw new Error(`receivepy_bytes expected Uint8Array payload, got ${typeof i}`);s.msg=i,t!==void 0&&(typeof t=="string"?s.worker_id||(s.worker_id=t):s={...t,...s});const d=s.worker_id;if(!d)throw new Error("Worker id not provided in receivepy_bytes");if(!e.workerState.worker[d])throw new Error(`Worker with id ${d} not found in receivepy_bytes`);e.workerState.receivepy_bytes(s.msg,d)}catch(s){console.error("Error during receivepy_bytes:",s);return}},e.startInitialization=({debug:r=!1,receivepy:t,receivepy_bytes:o,pyodide_url:n,post_pyodide_ready:s,packages:i})=>(e.workerState.debug=r,e.workerState.pyodide_url=n||p,e.workerState.packages=i,e.workerState.receivepy=t,e.workerState.receivepy_bytes=o,e.workerState.pyodideReadyPromise=null,e.workerState.post_pyodide_ready=s,e.workerState),e.register_cmd_message=(r,t)=>{if(e.workerState.handel_register[r])throw new Error(`Command ${r} already registered`);e.workerState.handel_register[r]=t},e.register_cmd_message("ping",async r=>"pong"),e.register_cmd_message("init",async r=>{if(e.workerState.pyodideReadyPromise)throw new Error("Pyodide is already initialized");r.data&&(r.data.pyodide_url&&(e.workerState.pyodide_url=r.data.pyodide_url),r.data.packages&&(e.workerState.packages=r.data.packages),r.data.debug&&(e.workerState.debug=r.data.debug)),e.workerState.pyodideReadyPromise=e.initializePyodide()}),e.register_cmd_message("_eval",async r=>{try{const t=await e.workerState.pyodide?.runPythonAsync(r.msg||"print('No code provided')");return console.log("Eval result:",t),t}catch(t){console.error("Error during _eval:",t)}}),e.register_cmd_message("state",async r=>({state:{...e.workerState.state,loaded:e.workerState.pyodideReady}})),e.register_cmd_message("worker:state",async r=>({state:{loaded:!!(await e.get_or_create_worker(r.worker_id)).worker}})),e.register_cmd_message("worker:stop",async r=>{if(!e.has_worker(r.worker_id))return;const t=await e.get_or_create_worker(r.worker_id);return t.worker&&(t.worker.stop(),t.worker=null,t.reject_promise?.("Worker stopped")),delete e.workerState.worker[r.worker_id],{state:{loaded:!1}}}),e.register_cmd_message("worker:send",async r=>{const t=await e.get_or_create_worker(r.worker_id);if(!t.worker)throw new Error("Worker is not initialized");if(typeof t.worker.receivejs!="function")throw new Error(`Worker does not support receivejs: ${typeof t.worker.receivejs}`);t.worker.receivejs(r.msg)}),e.handleMessage=async r=>{const t={original:r};r.id&&(t.id=r.id),r.toJs===void 0&&(r.toJs=!0);try{if(r.cmd){const o=r;if(e.workerState.handel_register[o.cmd])t.result=await e.workerState.handel_register[o.cmd](o);else throw new Error("Unknown command: "+o.cmd)}else throw new Error("Unknown message format: "+JSON.stringify(r))}catch(o){t.error=o.message}return t},e.read_url_params=()=>{const r=new URLSearchParams(self.location.search),t=r.get("debug")?.toLowerCase()==="true",o=r.get("pyodide_url")||void 0,n=r.get("packages")?.split(",")||[];return{debug:t,pyodide_url:o,packages:n}};const k=r=>{const t=new Set;return{add:o=>{t.add(o)},disconnect:o=>{t.delete(o)&&t.size===0&&r()},forEach:o=>{t.forEach(o)},size:()=>t.size}},w=e;w.general_initalization=r=>{const t=w.read_url_params();w.startInitialization({...r,...t})};const l=w,g=w;g.init_dedicated_worker=r=>{const t=e;t.onmessage=async n=>{const s=n.data,i=await t.handleMessage(s);t.postMessage(i)};const o={...r,receivepy:(n,s)=>{t.postMessage({cmd:"receive",msg:n,worker_id:s})},receivepy_bytes(n,s){t.postMessage({cmd:"receive_bytes",msg:n,worker_id:s})}};t.general_initalization(o)},l.init_shared_worker=r=>{const t=e,o=k(()=>{try{t.close()}catch{}});t.connectedPorts=[],t.onconnect=s=>{const i=s.ports[0];t.connectedPorts.push(i),o.add(i),i.start(),console.debug("Port connected in shared worker"),i.onmessage=async a=>{const d=a.data;if(d?.cmd==="disconnect"){o.disconnect(i),t.connectedPorts=t.connectedPorts.filter(m=>m!==i);try{i.onmessage=null}catch{}try{i.close()}catch{}return}const y=await t.handleMessage(d);i.postMessage(y)}};const n={...r,receivepy:(s,i)=>{o.forEach(a=>{a.postMessage({cmd:"receive",msg:s,worker_id:i})})},receivepy_bytes(s,i){o.forEach(a=>{a.postMessage({cmd:"receive_bytes",msg:s,worker_id:i})})}};t.general_initalization(n)};const u=r=>{w.init_dedicated_worker(r)};var _=`from __future__ import annotations
import funcnodes_core as fn

fn.node.ALLOW_REGISTERED_NODES_OVERRIDE = True


def eval_node_code(code: str):
    ns = {}  # dedicated namespace acting as globals
    exec(code, ns)
    _node = [
        cls
        for name, cls in ns.items()
        if isinstance(cls, type) and issubclass(cls, fn.Node)
    ][-1]
    return _node
`;function f(r){if(typeof r!="string"||!r.length)return[];const t=[],o=new Set,n=r.split(/\r?\n/);for(const s of n){const i=s.match(/^\s*#\s*requires\b\s*:?\s*(.*)$/i);if(!i)continue;const a=(i[1]??"").trim();if(a)for(const d of a.split(/[,\s]+/)){const y=d.trim();y&&(o.has(y)||(o.add(y),t.push(y)))}}return t}const c=w;c.nodebuilder_post_pyodide_ready=async r=>{await r.pyodide.runPythonAsync(_)},c.receivepy_bytes=(r,t)=>{let o=r;const n=r;if(n&&typeof n.toJs=="function")try{o=n.toJs({dict_converter:Object.fromEntries})}catch{o=n.toJs()}o instanceof Map&&(o=Object.fromEntries(o.entries()));try{let s={};if(o instanceof Uint8Array?s.msg=o:s=o,s.msg===void 0)return;let i=s.msg;const a=i;if(a&&typeof a.toJs=="function")try{i=a.toJs({dict_converter:Object.fromEntries})}catch{i=a.toJs()}if(i instanceof ArrayBuffer&&(i=new Uint8Array(i)),Array.isArray(i)&&(i=Uint8Array.from(i)),!(i instanceof Uint8Array))throw new Error(`receivepy_bytes expected Uint8Array payload, got ${typeof i}`);s.msg=i,t!==void 0&&(typeof t=="string"?s.worker_id||(s.worker_id=t):s={...t,...s});const d=s.worker_id;if(!d)throw new Error("Worker id not provided in receivepy_bytes");if(!c.workerState.worker[d])throw new Error(`Worker with id ${d} not found in receivepy_bytes`);c.workerState.receivepy_bytes(s.msg,d)}catch(s){console.error("Error during receivepy_bytes:",s)}},c.register_cmd_message("worker:evalnode",async r=>{const t=r.msg;console.log("evalnode",t);const o=f(t);console.log("requires",o);for(const i of o)await c.workerState.micropip.install(i);const n=await c.workerState.pyodide?.runPythonAsync(`eval_node_code(${JSON.stringify(t)})`);if(!n)return;const s=await c.get_or_create_worker(r.worker_id);s.worker.clear(),s.worker.nodespace.lib.add_node(n,"demo"),s.worker.add_node(n.node_id)}),u({post_pyodide_ready:c.nodebuilder_post_pyodide_ready})})();
